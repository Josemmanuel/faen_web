<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Documentos - FAEN</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>üìÑ Administraci√≥n de Documentos</h1>
            <p class="subtitle">Gestiona documentos PDF</p>
        </div>
    </header>

    <main class="dashboard-container">
        <!-- Sidebar de navegaci√≥n -->
        <aside class="dashboard-sidebar">
            <nav class="dashboard-nav">
                <a href="admin.html" class="nav-item">
                    <span class="nav-icon">üìã</span>
                    <span class="nav-text">Noticias</span>
                </a>
                <a href="admin.html" class="nav-item">
                    <span class="nav-icon">üñºÔ∏è</span>
                    <span class="nav-text">Galer√≠a</span>
                </a>
                <a href="admin-documents.html" class="nav-item active">
                    <span class="nav-icon">üìÑ</span>
                    <span class="nav-text">Documentos</span>
                </a>
                <a href="index.html" class="nav-item">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Ver Sitio</span>
                </a>
            </nav>
        </aside>

        <!-- Contenido Principal -->
        <div class="dashboard-content">
            <!-- Secci√≥n de Documentos -->
            <section class="dashboard-section active" id="section-documentos">
                <div class="section-header">
                    <h2>Gestionar Documentos</h2>
                    <button id="btn-nuevo-documento" class="btn btn-primary btn-large">
                        ‚ûï Nuevo Documento
                    </button>
                </div>

                <!-- Modal para crear/editar documento -->
                <div id="modal-documento" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modal-titulo">Nuevo Documento</h3>
                            <button class="modal-close" id="modal-close">&times;</button>
                        </div>
                        <form id="documento-form" enctype="multipart/form-data" class="modal-form">
                            <div class="form-group">
                                <label for="doc-title">T√≠tulo *</label>
                                <input type="text" id="doc-title" placeholder="Ej: Constancia de Inscripci√≥n 2025" required>
                            </div>

                            <div class="form-group">
                                <label for="doc-category">Categor√≠a *</label>
                                <select id="doc-category" required>
                                    <option value="">Seleccionar categor√≠a</option>
                                    <option value="constancias">üìú Constancias</option>
                                    <option value="notas">üìã Modelo de Notas</option>
                                    <option value="guias">üìñ Gu√≠as de Ayuda</option>
                                    <option value="otros">üìÅ Otros</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="doc-description">Descripci√≥n</label>
                                <textarea id="doc-description" placeholder="Descripci√≥n del documento" rows="4"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="doc-file">Archivo PDF *</label>
                                <div class="file-input-wrapper">
                                    <input type="file" id="doc-file" accept=".pdf" class="file-input" required>
                                    <label for="doc-file" class="file-label">Seleccionar PDF</label>
                                    <span id="file-name" class="file-name">Ning√∫n archivo seleccionado</span>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Guardar Documento</button>
                                <button type="button" id="form-cancel" class="btn btn-secondary">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Tabla de documentos -->
                <div class="table-wrapper">
                    <table class="documentos-table">
                        <thead>
                            <tr>
                                <th>T√≠tulo</th>
                                <th>Categor√≠a</th>
                                <th>Descripci√≥n</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="admin-docs-list">
                            <tr>
                                <td colspan="5" class="text-center">Cargando documentos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let credentials = null;
        let allDocuments = [];

        // Autenticaci√≥n
        window.addEventListener('load', () => {
            const user = prompt('Usuario:');
            const pass = prompt('Contrase√±a:');
            if (user && pass) {
                credentials = btoa(user + ':' + pass);
                loadDocuments();
            } else {
                window.location.href = 'admin.html';
            }
        });

        // Modal
        const modal = document.getElementById('modal-documento');
        const btnNuevo = document.getElementById('btn-nuevo-documento');
        const btnClose = document.getElementById('modal-close');
        const btnCancel = document.getElementById('form-cancel');
        const form = document.getElementById('documento-form');
        const fileInput = document.getElementById('doc-file');
        const fileName = document.getElementById('file-name');

        btnNuevo.addEventListener('click', () => {
            document.getElementById('modal-titulo').textContent = 'Nuevo Documento';
            form.reset();
            fileName.textContent = 'Ning√∫n archivo seleccionado';
            modal.style.display = 'block';
        });

        btnClose.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        btnCancel.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        fileInput.addEventListener('change', (e) => {
            fileName.textContent = e.target.files[0]?.name || 'Ning√∫n archivo seleccionado';
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('title', document.getElementById('doc-title').value);
            formData.append('category', document.getElementById('doc-category').value);
            formData.append('description', document.getElementById('doc-description').value);
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch(`${API_BASE}/documents`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Basic ' + credentials },
                    body: formData
                });

                if (response.ok) {
                    modal.style.display = 'none';
                    loadDocuments();
                } else {
                    alert('Error al guardar el documento');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        async function loadDocuments() {
            try {
                const response = await fetch(`${API_BASE}/documents`);
                allDocuments = await response.json();
                displayDocuments();
            } catch (err) {
                console.error('Error:', err);
            }
        }

        function displayDocuments() {
            const tbody = document.getElementById('admin-docs-list');
            if (allDocuments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay documentos</td></tr>';
                return;
            }

            tbody.innerHTML = allDocuments.map(doc => `
                <tr>
                    <td><strong>${doc.title}</strong></td>
                    <td><span class="badge">${getCategoryLabel(doc.category)}</span></td>
                    <td>${doc.description ? doc.description.substring(0, 50) + '...' : '-'}</td>
                    <td>${new Date(doc.uploadedAt).toLocaleDateString()}</td>
                    <td>
                        <a href="${doc.filePath}" target="_blank" class="btn btn-small btn-info">Ver</a>
                        <button class="btn btn-small btn-danger" onclick="deleteDoc('${doc.id}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        function getCategoryLabel(cat) {
            const labels = {
                constancias: 'üìú Constancias',
                notas: 'üìã Modelo de Notas',
                guias: 'üìñ Gu√≠as de Ayuda',
                otros: 'üìÅ Otros'
            };
            return labels[cat] || cat;
        }

        async function deleteDoc(id) {
            if (confirm('¬øEliminar este documento?')) {
                try {
                    const response = await fetch(`${API_BASE}/documents/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Basic ' + credentials }
                    });
                    if (response.ok) {
                        loadDocuments();
                    }
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            }
        }
    </script>
</body>
</html>
